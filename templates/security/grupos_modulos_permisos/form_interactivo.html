<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asignación de Permisos a Grupos y Módulos</title>
    <script src="https://kit.fontawesome.com/2c36e9b7b1.js" crossorigin="anonymous"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-slate-900 via-slate-800 to-slate-950 min-h-screen flex flex-col items-center py-10">
    <div class="w-full max-w-2xl bg-slate-800 rounded-2xl shadow-2xl p-8">
        <h1 class="text-3xl font-bold text-center text-cyan-300 mb-8 font-[Orbitron]">Asignar Permisos a Grupos y Módulos</h1>
        <!-- Selector de Grupo -->
        <div class="mb-6">
            <label for="grupoSelect" class="block text-cyan-200 font-bold mb-2">Grupo</label>
            <select id="grupoSelect" class="w-full p-3 rounded-lg bg-slate-900 text-cyan-100 border border-cyan-400 focus:outline-none">
                <option value="">Seleccione un grupo</option>
            </select>
        </div>
        <!-- Selector de Módulo -->
        <div class="mb-6">
            <label for="moduloSelect" class="block text-cyan-200 font-bold mb-2">Módulo</label>
            <select id="moduloSelect" class="w-full p-3 rounded-lg bg-slate-900 text-cyan-100 border border-cyan-400 focus:outline-none">
                <option value="">Seleccione un módulo</option>
            </select>
        </div>
        <!-- Permisos dinámicos -->
        <div id="permisosContainer" class="mb-6 hidden">
            <label class="block text-cyan-200 font-bold mb-2">Permisos disponibles</label>
            <div id="permisosCheckboxes" class="flex flex-wrap gap-4"></div>
        </div>
        <!-- Botones -->
        <div class="flex flex-col md:flex-row gap-4 justify-center mb-8">
            <button id="guardarBtn" class="bg-gradient-to-r from-cyan-600 via-blue-700 to-fuchsia-700 text-white py-3 px-8 rounded-xl font-bold font-[Orbitron] text-lg shadow-xl hover:from-cyan-400 hover:to-fuchsia-500 hover:scale-105 transition-all">Guardar Asignación</button>
            <button id="cancelarBtn" class="bg-gradient-to-r from-pink-600 via-fuchsia-700 to-cyan-700 text-white py-3 px-8 rounded-xl font-bold font-[Orbitron] text-lg shadow-xl hover:from-pink-400 hover:to-cyan-500 hover:scale-105 transition-all">Cancelar</button>
        </div>
        <!-- Resumen de asignaciones -->
        <div class="bg-slate-900 rounded-xl p-6 mt-6">
            <h2 class="text-xl font-bold text-cyan-200 mb-4">Asignaciones realizadas</h2>
            <ul id="resumenAsignaciones" class="space-y-3 text-cyan-100"></ul>
        </div>
    </div>
    <script>
    // Los datos reales se pasan desde el contexto Django como JSON seguro
    const grupos = JSON.parse('{{ grupos_json|safe|escapejs }}');
    const modulosPorGrupo = JSON.parse('{{ modulos_por_grupo_json|safe|escapejs }}');
    const permisosPorModulo = JSON.parse('{{ permisos_por_modulo_json|safe|escapejs }}');

    // Variable en memoria para guardar las asignaciones
    let asignaciones = [];

    // Referencias a elementos del DOM
    const grupoSelect = document.getElementById('grupoSelect');
    const moduloSelect = document.getElementById('moduloSelect');
    const permisosContainer = document.getElementById('permisosContainer');
    const permisosCheckboxes = document.getElementById('permisosCheckboxes');
    const guardarBtn = document.getElementById('guardarBtn');
    const cancelarBtn = document.getElementById('cancelarBtn');
    const resumenAsignaciones = document.getElementById('resumenAsignaciones');

    // Cargar opciones de grupos
    function cargarGrupos() {
        grupoSelect.innerHTML = '<option value="">Seleccione un grupo</option>';
        grupos.forEach(g => {
            const opt = document.createElement('option');
            opt.value = g.id;
            opt.textContent = g.nombre;
            grupoSelect.appendChild(opt);
        });
    }

    // Cargar módulos según grupo seleccionado
    function cargarModulos(grupoId) {
        moduloSelect.innerHTML = '<option value="">Seleccione un módulo</option>';
        if (!grupoId || !modulosPorGrupo[grupoId]) return;
        modulosPorGrupo[grupoId].forEach(m => {
            const opt = document.createElement('option');
            opt.value = m.id;
            opt.textContent = m.nombre;
            moduloSelect.appendChild(opt);
        });
    }

    // Mostrar permisos según módulo seleccionado
    function mostrarPermisos(moduloId) {
        permisosCheckboxes.innerHTML = '';
        if (!moduloId || !permisosPorModulo[moduloId] || permisosPorModulo[moduloId].length === 0) {
            permisosContainer.classList.add('hidden');
            return;
        }
        permisosPorModulo[moduloId].forEach(p => {
            const label = document.createElement('label');
            label.className = 'inline-flex items-center gap-2 text-cyan-100 bg-slate-700 px-3 py-2 rounded-lg shadow';
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.value = p.id;
            checkbox.className = 'form-checkbox accent-cyan-500';
            label.appendChild(checkbox);
            label.appendChild(document.createTextNode(p.nombre));
            permisosCheckboxes.appendChild(label);
        });
        permisosContainer.classList.remove('hidden');
    }

    // Eventos
    grupoSelect.addEventListener('change', function() {
        cargarModulos(this.value);
        moduloSelect.value = '';
        permisosCheckboxes.innerHTML = '';
        permisosContainer.classList.add('hidden');
    });
    moduloSelect.addEventListener('change', function() {
        mostrarPermisos(this.value);
    });

    // Guardar asignación en memoria y mostrar en la página (sin AJAX ni base de datos)
    guardarBtn.addEventListener('click', function(e) {
        e.preventDefault();
        const grupoId = parseInt(grupoSelect.value);
        const moduloId = parseInt(moduloSelect.value);
        if (!grupoId || !moduloId) {
            mostrarMensaje('Seleccione un grupo y un módulo.', 'error');
            return;
        }
        const grupo = grupos.find(g => g.id === grupoId);
        const modulo = (modulosPorGrupo[grupoId] || []).find(m => m.id === moduloId);
        const permisosMarcados = Array.from(permisosCheckboxes.querySelectorAll('input[type=checkbox]:checked')).map(cb => parseInt(cb.value));
        if (permisosMarcados.length === 0) {
            mostrarMensaje('Seleccione al menos un permiso.', 'error');
            return;
        }
        // Verificar si ya existe la asignación para ese grupo y módulo
        const yaExiste = asignaciones.some(a => a.grupoId === grupoId && a.moduloId === moduloId);
        if (yaExiste) {
            mostrarMensaje('Ya existe una asignación para este grupo y módulo.', 'error');
            return;
        }
        asignaciones.push({
            grupoId,
            grupoNombre: grupo.nombre,
            moduloId,
            moduloNombre: modulo.nombre,
            permisos: (permisosPorModulo[moduloId] || []).filter(p => permisosMarcados.includes(p.id))
        });
        mostrarResumen();
        // Limpiar selección
        moduloSelect.value = '';
        permisosCheckboxes.innerHTML = '';
        permisosContainer.classList.add('hidden');
        mostrarMensaje('¡Asignación registrada en memoria!', 'success');
    });

    // Función para mostrar mensajes visuales en la página
    function mostrarMensaje(texto, tipo) {
        let msg = document.getElementById('mensaje-flotante');
        if (!msg) {
            msg = document.createElement('div');
            msg.id = 'mensaje-flotante';
            msg.className = 'fixed top-6 left-1/2 -translate-x-1/2 z-50 px-6 py-3 rounded-xl shadow-xl text-lg font-bold font-[Orbitron] transition-all';
            document.body.appendChild(msg);
        }
        msg.textContent = texto;
        if (tipo === 'success') {
            msg.classList.remove('bg-pink-700', 'text-white');
            msg.classList.add('bg-cyan-700', 'text-white');
        } else {
            msg.classList.remove('bg-cyan-700', 'text-white');
            msg.classList.add('bg-pink-700', 'text-white');
        }
        msg.style.opacity = '1';
        setTimeout(() => {
            msg.style.opacity = '0';
        }, 2200);
    }

    // Función para obtener el token CSRF de las cookies
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Cancelar: limpia selección actual
    cancelarBtn.addEventListener('click', function(e) {
        e.preventDefault();
        grupoSelect.value = '';
        moduloSelect.innerHTML = '<option value="">Seleccione un módulo</option>';
        permisosCheckboxes.innerHTML = '';
        permisosContainer.classList.add('hidden');
    });

    // Mostrar resumen de asignaciones
    function mostrarResumen() {
        resumenAsignaciones.innerHTML = '';
        if (asignaciones.length === 0) {
            resumenAsignaciones.innerHTML = '<li class="text-slate-400">No hay asignaciones registradas.</li>';
            return;
        }
        asignaciones.forEach((a, idx) => {
            const li = document.createElement('li');
            li.className = 'bg-slate-800 rounded-lg p-4 shadow flex flex-col md:flex-row md:items-center md:gap-4';
            li.innerHTML = `<span class="font-bold text-cyan-300">${a.grupoNombre}</span> → <span class="font-bold text-fuchsia-300">${a.moduloNombre}</span> <span class="text-cyan-100">Permisos:</span> <span class="text-cyan-200">${a.permisos.map(p => p.nombre).join(', ')}</span>`;
            resumenAsignaciones.appendChild(li);
        });
    }

    // Inicializar opciones
    cargarGrupos();
    mostrarResumen();
    </script>
</body>
</html>
