{% extends 'home.html' %} 
<title>{% block title %}{{title|default:"Grupos Módulos Permisos"}}{% endblock %}</title>
{% load static %}
{% block content %}
<!-- Vincula el CSS de errores global -->
<link rel="stylesheet" href="{% static 'forms/error_form.css' %}">
<!-- Vincula el JS para vista previa de íconos -->
<script src="{% static 'forms/error_form.js' %}"></script>

<section class="dark:bg-principal min-h-screen flex items-start justify-center py-2">
    <div class="w-full max-w-2xl bg-gradient-to-br from-[#0b1121] via-[#18182f] to-[#1e293b] border-4 border-cyan-500/30 shadow-2xl rounded-3xl px-6 py-6 flex flex-col items-center backdrop-blur-md gap-6 mt-4">
        <h1 class="rounded-2xl bg-gradient-to-r from-cyan-500 via-fuchsia-600 to-blue-700 px-4 py-2 text-white uppercase text-3xl font-black tracking-widest shadow-lg font-[Orbitron] mb-1 text-center">
            {{ grabar|default:'Grabar Grupo Módulo Permiso' }}
        </h1>
        <!-- Mensajes de error del formulario (no específicos de campo) -->
        {% if form.non_field_errors %}
        <div class="w-full mb-4" data-aos="fade-up">
            <div class="bg-gradient-to-r from-pink-900/80 via-fuchsia-900/70 to-cyan-900/80 border-l-4 border-pink-500 p-4 rounded-xl max-w-xl mx-auto shadow-lg">
                <div class="flex items-start gap-4">
                    <div class="flex-shrink-0">
                        <i class="fa-solid fa-exclamation-triangle text-pink-400 text-2xl animate-pulse"></i>
                    </div>
                    <div class="ml-3">
                        <h3 class="text-pink-300 font-bold font-[Orbitron] text-lg">Se encontraron errores en el formulario:</h3>
                        <div class="mt-2 text-pink-200">
                            <ul class="list-disc list-inside space-y-1">
                                {% for error in form.non_field_errors %}
                                <li>{{ error }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
        <form method="post" class="w-full flex flex-col gap-6">
            {% csrf_token %}
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 w-full">
                <!-- Campo Grupo -->
                <div class="field-container w-full flex flex-col gap-2 items-center {% if form.group.errors %}has-error{% endif %}">
                    <label for="{{ form.group.id_for_label }}"
                        class="font-black uppercase text-base block tracking-widest text-cyan-300 text-center font-[Orbitron] mb-1">
                        {{ form.group.label }}
                        {% if form.group.field.required %}<span class="text-pink-400">*</span>{% endif %}
                    </label>
                    <div class="relative flex justify-center w-full">
                        <div class="w-full" style="max-width: 220px;">
                            <div class="relative">
                                {{ form.group }}
                                <span class="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none text-cyan-400">
                                    <i class="fa-solid fa-chevron-down"></i>
                                </span>
                            </div>
                        </div>
                        {% if form.group.errors %}
                        <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                            <i class="fa-solid fa-exclamation-circle text-pink-400"></i>
                        </div>
                        {% endif %}
                    </div>
                    {% if form.group.errors %}
                    <div class="mt-1 text-pink-400 text-xs text-center">
                        {% for error in form.group.errors %}
                        <div class="flex items-center mt-1 justify-center gap-2">
                            <i class="fa-solid fa-circle-exclamation text-xs"></i>
                            {{ error }}
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
                <!-- Campo Módulo -->
                <div class="field-container w-full flex flex-col gap-2 items-center {% if form.module.errors %}has-error{% endif %}">
                    <label for="{{ form.module.id_for_label }}"
                        class="font-black uppercase text-base block tracking-widest text-cyan-300 text-center font-[Orbitron] mb-1">
                        {{ form.module.label }}
                        {% if form.module.field.required %}<span class="text-pink-400">*</span>{% endif %}
                    </label>
                    <div class="relative flex justify-center w-full">
                        <div class="w-full" style="max-width: 220px;">
                            <div class="relative">
                                {{ form.module }}
                                <span class="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none text-cyan-400">
                                    <i class="fa-solid fa-chevron-down"></i>
                                </span>
                            </div>
                        </div>
                        {% if form.module.errors %}
                        <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                            <i class="fa-solid fa-exclamation-circle text-pink-400"></i>
                        </div>
                        {% endif %}
                    </div>
                    {% if form.module.errors %}
                    <div class="mt-1 text-pink-400 text-xs text-center">
                        {% for error in form.module.errors %}
                        <div class="flex items-center mt-1 justify-center gap-2">
                            <i class="fa-solid fa-circle-exclamation text-xs"></i>
                            {{ error }}
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
            </div>
            <!-- Campo Permisos -->
            <div class="w-full max-w-xl mx-auto flex flex-col gap-2">
                <label for="{{ form.permissions.id_for_label }}"
                    class="font-black uppercase text-base block tracking-widest text-cyan-300 text-center font-[Orbitron] mb-1">
                    {{ form.permissions.label }}
                    {% if form.permissions.field.required %}<span class="text-pink-400">*</span>{% endif %}
                </label>
                <div class="relative flex flex-col items-center">
                    <div id="permissions-checkboxes-wrapper" class="w-full max-w-md mx-auto bg-slate-900 border-2 border-cyan-400 rounded-xl p-3 flex flex-wrap gap-3 overflow-x-hidden overflow-y-auto shadow-lg" style="max-height: 140px; min-height: 50px;">
                        {# Renderizamos los checkboxes de permisos con un data-perm-module-id para filtrar con JS #}
                        {% for perm in form.permissions.field.queryset %}
                            <div class="perm-checkbox w-full md:w-1/2 flex items-center gap-2 bg-slate-800 rounded-lg px-2 py-1 shadow border border-cyan-700 mb-1" data-perm-module-ids="{{ perm.module_set.all|join:','|default:'' }}" style="display:none">
                                <label class="flex items-center gap-2 w-full cursor-pointer">
                                    <input type="checkbox" name="permissions" value="{{ perm.id }}" id="id_permissions_{{ forloop.counter0 }}" class="form-checkbox accent-cyan-500 scale-110">
                                    <span class="text-cyan-100 font-semibold text-sm">{{ perm.name }}</span>
                                </label>
                            </div>
                        {% endfor %}
                    </div>
                    {% if form.permissions.errors %}
                    <div class="mt-1 text-pink-400 text-xs text-center w-full">
                        {% for error in form.permissions.errors %}
                        <div class="flex items-center mt-1 justify-center gap-2">
                            <i class="fa-solid fa-circle-exclamation text-xs"></i>
                            {{ error }}
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
            </div>
            <!-- Botones de acción -->
            <div class="flex flex-col md:flex-row justify-center items-center gap-4 w-full mt-4">
                <button type="submit"
                    class="cyber-btn w-auto max-w-[130px] min-w-[110px] px-4 bg-gradient-to-r from-cyan-600 via-blue-700 to-fuchsia-700 text-white py-2 rounded-xl flex items-center justify-center transition-all duration-300 font-black font-[Orbitron] text-base shadow-xl hover:from-cyan-400 hover:to-fuchsia-500 hover:scale-105 tracking-widest">
                    <i class="fa-solid fa-save mr-2"></i>{{ grabar|default:'Guardar' }}
                </button>
                <a class="cyber-btn w-auto max-w-[130px] min-w-[110px] px-4 bg-gradient-to-r from-pink-600 via-fuchsia-700 to-cyan-700 text-white py-2 rounded-xl flex items-center justify-center transition-all duration-300 font-black font-[Orbitron] text-base shadow-xl hover:from-pink-400 hover:to-cyan-500 hover:scale-105 tracking-widest"
                    href="{{ back_url|default:'#' }}">
                    <i class="fa-solid fa-xmark mr-2"></i>Cancelar
                </a>
            </div>
        </form>
    </div>
</section>
<script>
// module_permissions viene del contexto, es un dict: {module_id: [{id, name, codename}, ...], ...}
const modulePermissions = {{ module_permissions|safe }};
window.addEventListener('DOMContentLoaded', function() {
    const moduleSelect = document.getElementById('id_module');
    const permissionsWrapper = document.getElementById('permissions-checkboxes-wrapper');
    function updatePermissions() {
        const selectedModule = moduleSelect.value;
        // Oculta todos los checkboxes
        permissionsWrapper.querySelectorAll('.perm-checkbox').forEach(div => div.style.display = 'none');
        if (selectedModule && modulePermissions[selectedModule]) {
            // Muestra solo los checkboxes de los permisos de ese módulo
            modulePermissions[selectedModule].forEach(perm => {
                const checkbox = permissionsWrapper.querySelector('input[value="'+perm.id+'"]');
                if (checkbox) {
                    checkbox.parentElement.parentElement.style.display = '';
                }
            });
        }
    }
    if (moduleSelect) {
        moduleSelect.addEventListener('change', updatePermissions);
        updatePermissions(); // Inicializa al cargar
    }
});
</script>
{% endblock %}