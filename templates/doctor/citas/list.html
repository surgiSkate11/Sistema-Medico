{% extends 'base.html' %}
{% load static %}
{% block title %}Agenda de Citas Futurista{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'appointments/citas.css' %}">
{% endblock %}

{% block content %}
<div class="citas-container py-10 px-2 md:px-8 fade-in">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-8">
        <div>
            <h1 class="text-4xl font-extrabold text-white tracking-tight flex items-center gap-3 animate-fadein-down">
                <i class="fa-solid fa-calendar-check text-indigo-400 text-3xl"></i>
                Citas Médicas
            </h1>
            <p class="text-violet-200 text-lg mt-1 animate-fadein-down">Gestiona y visualiza tus citas de manera intuitiva y elegante</p>
        </div>
        <button id="openCitaModal" class="btn-glass pulse-accent flex items-center gap-2 px-7 py-3 rounded-xl font-bold animate-fadein-up shadow-xl">
            <i class="fa-solid fa-plus"></i> Nueva Cita
        </button>
    </div>
    <!-- Filtro de búsqueda -->
    <form method="get" class="mb-8 flex flex-col sm:flex-row gap-2 animate-fadein-up">
        <input type="text" name="q" placeholder="Buscar por paciente, médico o motivo..." value="{{ request.GET.q }}"
               class="search-glass px-4 py-2 rounded-xl w-full sm:w-96 text-white placeholder-indigo-200 focus:outline-none focus:ring-2 focus:ring-indigo-400 transition">
        <button type="submit" class="btn-glass px-6 py-2 rounded-xl font-bold text-white shadow">Buscar</button>
    </form>
    <!-- Tabla de citas -->
    <div class="overflow-x-auto rounded-3xl shadow-2xl glass-bg animate-fadein-up">
        <table class="min-w-full divide-y divide-indigo-300 citas-table">
            <thead>
                <tr>
                    <th>Paciente</th>
                    <th>Médico</th>
                    <th>Fecha</th>
                    <th>Hora</th>
                    <th>Motivo</th>
                    <th>Estado</th>
                    <th class="text-center">Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for appointment in appointments %}
                <tr class="hover-row">
                    <td>
                        <span class="font-bold text-indigo-200">{{ appointment.patient }}</span>
                    </td>
                    <td>{{ appointment.doctor_name|default:"-" }}</td>
                    <td>{{ appointment.date|date:'d/m/Y' }}</td>
                    <td>{{ appointment.time|time:'H:i' }}</td>
                    <td>{{ appointment.reason }}</td>
                    <td>
                        {% if appointment.is_active %}
                        <span class="badge badge-active pulse-badge">Activa</span>
                        {% else %}
                        <span class="badge badge-inactive">Inactiva</span>
                        {% endif %}
                    </td>
                    <td class="text-center flex justify-center gap-2">
                        <a href="{% url 'doctor:appointment_update' appointment.id %}" class="action-btn edit ripple">
                            <i class="fa-solid fa-pen-to-square"></i>
                        </a>
                        <a href="{% url 'doctor:appointment_delete' appointment.id %}" class="action-btn delete ripple">
                            <i class="fa-solid fa-trash"></i>
                        </a>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="7" class="py-8 text-center text-xl text-indigo-300 animate-fadein-down">
                        <i class="fa-regular fa-calendar-xmark text-4xl mb-2"></i>
                        <br>No hay citas registradas.
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    <!-- Paginación -->
    {% if is_paginated %}
    <div class="pagination-glass flex justify-center mt-8 gap-2">
        {% if page_obj.has_previous %}
        <a href="?page={{ page_obj.previous_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}" class="paginate-btn">Anterior</a>
        {% endif %}
        <span class="paginate-info">Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}</span>
        {% if page_obj.has_next %}
        <a href="?page={{ page_obj.next_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}" class="paginate-btn">Siguiente</a>
        {% endif %}
    </div>
    {% endif %}
</div>

<!-- Modal Nueva Cita -->
<div id="citaModal" class="modal-glass hidden fixed inset-0 z-50 flex items-center justify-center">
    <div class="modal-content-glass relative w-full max-w-lg p-8 rounded-3xl shadow-2xl animate-fadein-up">
        <button id="closeCitaModal" class="absolute top-4 right-7 text-2xl text-violet-300 hover:text-pink-400 transition">
            <i class="fa-solid fa-xmark"></i>
        </button>
        <h2 class="text-2xl font-bold text-indigo-300 mb-4 flex items-center gap-2">
            <i class="fa-solid fa-calendar-plus"></i> Nueva Cita
        </h2>
        <form id="formNuevaCita" method="post" action="{{ create_url }}" class="space-y-4">
            {% csrf_token %}
            <div>
                <label class="label-glass">Paciente</label>
                <select name="patient" required class="input-glass">
                    <option value="">Selecciona un paciente</option>
                    {% for p in patients %}
                        <option value="{{ p.id }}">{{ p }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="flex gap-4">
                <div class="w-1/2">
                    <label class="label-glass">Fecha</label>
                    <input type="date" name="date" required class="input-glass">
                </div>
                <div class="w-1/2">
                    <label class="label-glass">Hora</label>
                    <input type="time" name="time" required class="input-glass">
                </div>
            </div>
            <div>
                <label class="label-glass">Motivo</label>
                <input type="text" name="reason" required class="input-glass" placeholder="Motivo de la cita">
            </div>
            <div>
                <label class="label-glass">Notas</label>
                <textarea name="notes" class="input-glass" rows="2" placeholder="Notas adicionales..."></textarea>
            </div>
            <div class="flex justify-end">
                <button type="submit" class="btn-glass px-6 py-2 rounded-xl font-bold shadow ripple">Guardar</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'appointments/citas.js' %}"></script>
{% endblock %}